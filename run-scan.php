<?php 
$script_name = $_SERVER['SCRIPT_URI'];
$current_dir = dirname(__FILE__);
?>
<?php if ( !isset($_GET['_rnsc']) ): ?>
    <!doctype html>
    <html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>~~ 22 | malware scan ~~</title>
        <link href="//cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <style>
            .card-list-files{
                max-height: 800px;
                overflow: auto;
            }
            .container-file-modal{
                max-height: 750px;
                overflow: auto;
            }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/codemirror.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/codemirror.min.css" />

        <style type="text/css">
            .CodeMirror {
                font-size: 15px;
                width: 100%, ;
                height: 100%;
            }
        </style>
    </head>
    <body class="bg-black">
        <div class="container">
            <div class="heading text-center mt-4 text-white">
                <h1 class="text-center">22 | MALWARE SCANNER</h1>
                <small><a href="mailto:rivomanana.dev@gmail.com">rivomanana.dev@gmail.com</a></small>
            </div>

            <div class="scan-content mt-4">
                <div class="progress" role="progressbar" aria-label="Animated striped example" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%">Chargement...</div>
                </div>
                <div class="row result-content">

                </div>
            </div>

        </div>
        <script src="//cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <script>
            const progress = document.querySelector('.progress')
            fetch('<?= $script_name; ?>?_rnsc').then(r => r.json())
            .then(response => {
                progress.style.display = 'none';
                document.querySelector('.result-content').innerHTML = `${response.files} ${response.infos}`

                const myModalEl = document.querySelectorAll('.modal-file')
                myModalEl.forEach((modal, k) => {
                    modal.addEventListener('shown.bs.modal', event => {
                        const el = event.target
                        el.querySelector('.container-file-modal-code').innerHTML = '';
                        const id = el.getAttribute('data-id')
                        const loading = el.querySelector(`#loading-${id}`)
                        fetch( `<?= $script_name; ?>?_rnsc&_file=${el.getAttribute('data-file')}` ).then(r => r.json())
                            .then(response => {
                                loading.style.display = 'none'
                                console.log(response)
                                const editor = CodeMirror( el.querySelector('.container-file-modal-code'), {

                                    lineWrapping: true,
                                    lineNumbers: true,
                                    styleActiveLine: true,
                                    matchBrackets: true,
                                    value: response.content
                                });
                                //el.querySelector('.container-file-modal-code').innerHTML = `<code>${response.content}</code>`
                            })
                    })
                });

                document.querySelectorAll('.delete-file').forEach((btn, k) => {
                    btn.addEventListener('click', e => {
                        e.preventDefault();
                        if ( confirm( '!!!!! Tena sur tena a !!!!!! ??' ) ){
                            fetch( `<?= $script_name; ?>?_rnsc&_file=${e.target.getAttribute('data-file')}&mode=delete` ).then(r => r.json())
                                .then(response => {
                                    bootstrap.Modal.getInstance( document.querySelector(`#${e.target.getAttribute('data-this-modal')}`) ).hide()
                                    document.querySelectorAll(`[data-file-line="${e.target.getAttribute('data-this-file-item')}"]`).forEach((li, k) => {
                                        li.style.display = 'none'
                                    })
                                })
                        }
                    })
                })
            })



        </script>
    </body>
    </html>
<?php else : ?>
    <?php

    if ( isset($_GET['_file']) ){
        $mode = isset($_GET['mode']) ? isset($_GET['mode']) : 'create';
        $file = base64_decode( $_GET['_file'] );
        $out = new stdClass();
        $out->success = false;
        $out->content = 'Fichier introuvable';
        if ( file_exists( $file ) ){
            switch ( $mode ){
                case 'delete':
                    @chmod( $file, 0755 );
                    @unlink( $file );
                    $out->success = true;
                    $out->content = $file;
                    break;
                default:
                    $out->success = true;
                    $out->content = file_get_contents( $file );
                    break;
            }

        }
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode($out);
        exit;
    } else {
        require_once './libs-scan/scan.php';
        ob_start();

        $scan = new MalwareScanner();
        $scan->setFlagScanEverything(true);
        $scan->setFlagHideOk(true);
        $scan->setExtensions(['.php', '.js']);

        $scan->run($current_dir . DIRECTORY_SEPARATOR );

        $content = ob_get_contents();
        ob_end_clean();

        $data = explode('}', $content);

        $out = new stdClass();
        $out->infos = '<div class="col-4">
        <div class="card">
            <div class="card-header">
            <pre>Informations</pre>
            </div>
            <div class="card-body"><pre>'.nl2br($data[ sizeof( $data ) - 1 ]).'</pre></div>
        </div>
        
    </div>';
        unset( $data[ sizeof( $data ) - 1 ] );
        $file_html = [];
        foreach ( $data as $item_data ){
            [$first, $last] = explode('{', $item_data);
            if ( preg_match('/# ER/', $first) and file_exists( $last ) ){
                $file_html[] = '
                <li class="list-group-item" data-file-line="file-item-'.md5($last).'">
                    <a href="javascript:;" data-bs-toggle="modal" data-bs-target="#modal-'.md5($last).'" ><code>'.$last.'</code></a>
                    <div data-id="'.md5($last).'" data-file="'.base64_encode($last).'" class="modal modal-lg fade modal-file" id="modal-'.md5($last).'" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">'.pathinfo($last, PATHINFO_BASENAME).'</h1>
                            
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                                <p><small><code><i>'.$last.'</i></code></small></p>
                                <div class="">
                                      <pre id="loading-'.md5($last).'">Chargement...</pre>    
                                      <div class="container-file-modal">
                                        <div class="container-file-modal-code "></div>
                                      </div> 
                                      
                                </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                            <button type="button" class="btn btn-danger delete-file" data-this-file-item="file-item-'.md5($last).'" data-this-modal="modal-'.md5($last).'" data-file="'.base64_encode($last).'">Supprimer le fichier</button>
                          </div>
                        </div>
                      </div>
                    </div>
                </li>
            ';
            }

        }
        $out->files = '
    <div class="col-8">
        <div class="card">
            <div class="card-body">
                <div class="card-list-files">
                    <ul class="list-group list-group-flush">
                        '.implode("\n", $file_html).'
                    </ul>
                </div>
            </div>
        </div>
    </div>        
    ';
        header('Content-Type: application/json; charset=utf-8');
        echo json_encode($out);
        exit;
    }


endif;



